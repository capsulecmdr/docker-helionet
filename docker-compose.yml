services:
  web:
    image: ghcr.io/capsulecmdr/helionet:latest
    container_name: helionet-web
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8080:80"          # http://localhost:8080 â†’ app
    #volumes:
    #  - ../helionet:/var/www/html #comment this out for production use.
    networks:
      - internal
      - public
    environment:
      # Laravel will mainly use /var/www/html/.env, but these help for CLI and defaults
      APP_ENV: local
      APP_DEBUG: "true"
      APP_URL: http://localhost:8080

      DB_HOST: db
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE:-helionet}
      DB_USERNAME: ${DB_USERNAME:-helionet}
      DB_PASSWORD: ${DB_PASSWORD:-secret}

  worker:
    image: ghcr.io/capsulecmdr/helionet:latest
    user: "helios"
    container_name: helionet-worker
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    #volumes:
    #  - ../helionet:/var/www/html
    networks:
      - internal
    # Override CMD from Dockerfile: run the queue worker instead of supervisord
    command: php artisan horizon

  scheduler:
    image: ghcr.io/capsulecmdr/helionet:latest
    user: "helios"
    container_name: helionet-scheduler
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    #volumes:
    #  - ../helionet:/var/www/html
    networks:
      - internal
    # Continuous scheduler loop
    command: php artisan schedule:work

  db:
    image: mariadb:11
    container_name: helionet-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-helionet}
      MYSQL_USER: ${DB_USERNAME:-helionet}
      MYSQL_PASSWORD: ${DB_PASSWORD:-secret}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin ping -h 127.0.0.1 --silent || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  redis:
    image: redis:7
    container_name: helionet-redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    networks:
      - internal
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    depends_on:
      db:
        condition: service_healthy

volumes:
  db_data:
  redis_data:

networks:
  internal:
    internal: true
  public:
    driver: bridge
